import datetime
import calendar
from telegram import Update, ReplyKeyboardMarkup
from telegram.ext import (
    ApplicationBuilder,
    CommandHandler,
    MessageHandler,
    ConversationHandler,
    ContextTypes,
    filters,
)

TOKEN = "8533132786:AAGW6a8UH_J0NwrlIfeeBMpnA8voilfrxAA"
CHAT_ID = None  # —Å–æ—Ö—Ä–∞–Ω–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

PERCENT, SHIFT, CASH, BONUS = range(4)

salary_data = {
    "first": [],
    "second": []
}

def get_period():
    day = datetime.datetime.now().day
    return "first" if day <= 14 else "second"

async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    global CHAT_ID
    CHAT_ID = update.message.chat_id

    keyboard = [["üí∞ –£–∑–Ω–∞—Ç—å –ó–ü", "üìù –û—Ç—á–µ—Ç –æ —Å–º–µ–Ω–µ"]]
    await update.message.reply_text(
        "–í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ:",
        reply_markup=ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
    )

# ---------------- –û–¢–ß–ï–¢ ----------------

async def report_start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    await update.message.reply_text("–í–≤–µ–¥–∏—Ç–µ % —Å –ø—Ä–æ–¥–∞–∂–∏:")
    return PERCENT

async def percent_step(update: Update, context: ContextTypes.DEFAULT_TYPE):
    context.user_data["percent"] = float(update.message.text)
    await update.message.reply_text("–í–≤–µ–¥–∏—Ç–µ –≤—ã—Ö–æ–¥ –∑–∞ —Å–º–µ–Ω—É:")
    return SHIFT

async def shift_step(update: Update, context: ContextTypes.DEFAULT_TYPE):
    context.user_data["shift"] = float(update.message.text)
    await update.message.reply_text("–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –∫–∞—Å—Å—ã:")
    return CASH

async def cash_step(update: Update, context: ContextTypes.DEFAULT_TYPE):
    context.user_data["cash"] = float(update.message.text)
    await update.message.reply_text("–í–≤–µ–¥–∏—Ç–µ –ø—Ä–µ–º–∏–∏ (–µ—Å–ª–∏ –Ω–µ—Ç ‚Äî 0):")
    return BONUS

async def bonus_step(update: Update, context: ContextTypes.DEFAULT_TYPE):
    bonus = float(update.message.text)
    data = context.user_data

    total = (data["cash"] * data["percent"] / 100) + data["shift"] + bonus
    period = get_period()
    salary_data[period].append(total)

    await update.message.reply_text(
        f"‚úÖ –û—Ç—á–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω\n"
        f"–ó–∞—Ä–∞–±–æ—Ç–∞–Ω–æ –∑–∞ —Å–º–µ–Ω—É: {total:.2f}"
    )
    return ConversationHandler.END

# ---------------- –ó–ü ----------------

async def salary(update: Update, context: ContextTypes.DEFAULT_TYPE):
    period = get_period()
    total = sum(salary_data[period])
    name = "1‚Äì14" if period == "first" else "15‚Äì–∫–æ–Ω–µ—Ü –º–µ—Å—è—Ü–∞"

    await update.message.reply_text(
        f"üí∞ –í–∞—à–∞ –ó–ü –∑–∞ –ø–µ—Ä–∏–æ–¥ {name}:\n{total:.2f}"
    )

# ---------------- –ê–í–¢–û–í–´–ü–õ–ê–¢–ê ----------------

async def auto_payout(context: ContextTypes.DEFAULT_TYPE):
    global CHAT_ID
    if CHAT_ID is None:
        return

    today = datetime.datetime.now()
    day = today.day
    last_day = calendar.monthrange(today.year, today.month)[1]

    if day == 15:
        period = "first"
        text_period = "1‚Äì14"
    elif day == last_day:
        period = "second"
        text_period = "15‚Äì–∫–æ–Ω–µ—Ü –º–µ—Å—è—Ü–∞"
    else:
        return

    total = sum(salary_data[period])
    salary_data[period].clear()

    await context.bot.send_message(
        chat_id=CHAT_ID,
        text=(
            f"üí∏ –í—ã–ø–ª–∞—Ç–∞ –ó–ü\n"
            f"–ü–µ—Ä–∏–æ–¥: {text_period}\n"
            f"–ò—Ç–æ–≥–æ: {total:.2f}"
        )
    )

# ---------------- MAIN ----------------

def main():
    app = ApplicationBuilder().token(TOKEN).build()

    conv = ConversationHandler(
        entry_points=[MessageHandler(filters.TEXT & filters.Regex("–û—Ç—á–µ—Ç"), report_start)],
        states={
            PERCENT: [MessageHandler(filters.TEXT, percent_step)],
            SHIFT: [MessageHandler(filters.TEXT, shift_step)],
            CASH: [MessageHandler(filters.TEXT, cash_step)],
            BONUS: [MessageHandler(filters.TEXT, bonus_step)],
        },
        fallbacks=[]
    )

    app.add_handler(CommandHandler("start", start))
    app.add_handler(MessageHandler(filters.TEXT & filters.Regex("–ó–ü"), salary))
    app.add_handler(conv)

    # –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –≤ 10:00
    app.job_queue.run_daily(
        auto_payout,
        time=datetime.time(hour=10, minute=0)
    )

    app.run_polling()

if __name__ == "__main__":
    main()
